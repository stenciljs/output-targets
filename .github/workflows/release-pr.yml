name: 'Production Release PR'

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch for the release PR'
        required: false
        default: 'main'
        type: string

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: ðŸŸ¢ Use Node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20.10.0'
          cache: 'pnpm'

      - name: ðŸ“¦ Install Dependencies
        run: pnpm install
        shell: bash

      - name: ðŸ” Analyze Changes (Dry Run)
        id: analyze
        run: |
          echo "Running semantic-release in dry-run mode to analyze changes..."
          timeout 300 pnpm run release:prepare > semantic-release-output.txt 2>&1 || true
          cat semantic-release-output.txt

          # Check if any releases will be created
          # Look for either semantic-release output OR our manual commit count
          if grep -q -E "(The next release version is|Changes detected|Found [0-9]+ commit)" semantic-release-output.txt; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected - will create release PR"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No releasable changes detected"
          fi
        shell: bash

      - name: âš™ï¸ Configure Git
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
        shell: bash

      - name: ðŸ”„ Create Release Branch
        if: steps.analyze.outputs.has_changes == 'true'
        id: create_branch
        run: |
          BRANCH_NAME="release/automated-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"
        shell: bash

      - name: ðŸ“ Run Semantic Release
        if: steps.analyze.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running semantic-release to update versions and changelog..."
          pnpm run release:version
        shell: bash

      - name: ðŸ“¤ Push Release Branch
        if: steps.analyze.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.create_branch.outputs.branch_name }}
        shell: bash

      - name: ðŸ”– Extract Release Information
        if: steps.analyze.outputs.has_changes == 'true'
        id: release_info
        run: |
          # Extract information about what packages were updated
          PACKAGES_UPDATED=$(git log -1 --pretty=%B | grep -oP '@stencil/[a-z-]+@\d+\.\d+\.\d+' || echo "")

          if [ -z "$PACKAGES_UPDATED" ]; then
            echo "description=Automated release preparation" >> $GITHUB_OUTPUT
          else
            echo "description<<EOF" >> $GITHUB_OUTPUT
            echo "## Packages Updated" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$PACKAGES_UPDATED" | while read -r package; do
              echo "- \`$package\`" >> $GITHUB_OUTPUT
            done
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: ðŸ“¬ Create Pull Request
        if: steps.analyze.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest commit message which contains the release notes
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # Create PR body
          cat > pr_body.md <<'EOF'
          ## ðŸš€ Automated Release PR

          This PR was automatically generated by the semantic-release workflow.

          ### Changes

          This PR includes:
          - âœ… Version bumps for affected packages based on conventional commits
          - âœ… Updated CHANGELOG.md with release notes

          ### What's included

          EOF

          # Add commit message details
          echo '```' >> pr_body.md
          echo "$COMMIT_MSG" >> pr_body.md
          echo '```' >> pr_body.md

          cat >> pr_body.md <<'EOF'

          ### Next Steps

          1. Review the version bumps and changelog updates
          2. Ensure all changes are correct
          3. Merge this PR to `${{ inputs.base_branch }}`
          4. After merging, trigger the production release workflow for each package

          ---

          **Note**: This PR does NOT publish to npm. After merging, you must manually trigger the [Production Release workflow](../../actions/workflows/prod-build.yml) for each package you want to publish.
          EOF

          # Create the PR
          gh pr create \
            --title "chore(release): automated release preparation" \
            --body-file pr_body.md \
            --base "${{ inputs.base_branch }}" \
            --head "${{ steps.create_branch.outputs.branch_name }}"
        shell: bash

      - name: â„¹ï¸ No Changes Required
        if: steps.analyze.outputs.has_changes == 'false'
        run: |
          echo "::notice::No releasable changes detected. No PR will be created."
          echo "This usually means there are no conventional commits since the last release."
          echo ""
          echo "Conventional commit format: <type>(<scope>): <message>"
          echo "Examples:"
          echo "  - feat(vue): add new feature"
          echo "  - fix(react): fix bug"
          echo "  - fix(angular): correct typing issue"
        shell: bash
