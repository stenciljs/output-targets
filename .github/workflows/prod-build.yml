name: 'Production Release'

on:
  workflow_dispatch:
    inputs:
      package:
        required: true
        type: choice
        description: Which package should be published?
        options:
          - vue
          - angular
          - react
          - ssr
      tag:
        required: true
        type: choice
        description: Which npm tag should this be published to?
        options:
          - latest
          - next
      preid:
        type: choice
        description: Which prerelease identifier should be used? This is only needed when version is "prepatch", "preminor", "premajor", or "prerelease".
        default: ''
        options:
          - '' # no prerelease
          - alpha
          - beta
          - rc
          - next
jobs:
  prod-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ steps.prod-build.outputs.version }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: ðŸŸ¢ Use Node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20.10.0'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
      - name: ðŸ“¦ Install Dependencies
        run: pnpm install
        shell: bash
      - name: ðŸ”Ž Get Version
        id: prod-build
        run: |
          VERSION=$(node -p "require('./packages/${{ inputs.package }}/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash
      - name: ðŸ“¦ Publish Package
        uses: ./.github/workflows/publish-npm.yml
        with:
          tag: ${{ inputs.tag }} # "latest" or "next"
          preid: ${{ inputs.preid }} # Only needed when version is "prepatch", "preminor", "premajor", or "prerelease"
          scope: ${{ inputs.package == 'ssr' && '@stencil/ssr' || format('@stencil/{0}-output-target', inputs.package) }}
          # Look at package.json's name
          # Coupled to project structure. Update this when adding a new output target.
          # Examples: vue-output-target, angular-output-target, react-output-target
          working-directory: './packages/${{ inputs.package }}' # Follow the repo structure
